<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∑ŸÑÿßÿ®</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --success-color: #43a047;
      --text-color: #2d3748;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    th, td {
      border: 1px solid var(--gray-light);
      padding: 12px 15px;
      text-align: center;
      font-size: 15px;
    }
    
    th {
      background-color: var(--primary-color);
      color: var(--white);
      font-weight: 500;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    tr:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .login-box {
      background: var(--white);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    #studentsCount {
      text-align: center;
      font-weight: bold;
      margin: 20px 0;
      color: var(--text-color);
      font-size: 18px;
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 25px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .close {
      color: #aaa;
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: var(--text-color);
    }
    
    .modal-body {
      padding: 20px 0;
    }
    
    .modal-footer {
      text-align: left;
      padding-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-title {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 22px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .attendance-select, .fee-checkbox {
      margin: 5px 0;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .grade-select {
        width: 100%;
      }
      
      .grade-select button {
        width: 100%;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .login-box {
        padding: 30px 20px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer button {
        width: 100%;
      }
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2>üîí ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
      <input type="password" id="loginPassword" placeholder="ÿßÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
      <button class="btn btn-success" onclick="checkLogin()">ÿØÿÆŸàŸÑ</button>
    </div>
  </div>

  <div class="container">
    <!-- Modal for Add/Edit Student -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title" id="modalTitle">ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ®</h3>
        <div class="modal-body">
          <div class="form-group">
            <label for="studentId">ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ®</label>
            <input type="text" id="studentId" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ®">
          </div>
          <div class="form-group">
            <label for="studentName">ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®</label>
            <input type="text" id="studentName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®">
          </div>
          <div class="form-group">
            <label for="studentGrade">ÿßŸÑÿµŸÅ</label>
            <select id="studentGrade">
              <option value="" disabled selected>ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ</option>
            </select>
          </div>
          <div class="form-group">
            <label for="studentLevel">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</label>
            <select id="studentLevel">
              <option value="" disabled selected>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</option>
              <option value="ÿ∂ÿπŸäŸÅ">ÿ∂ÿπŸäŸÅ</option>
              <option value="ŸÖŸÇÿ®ŸàŸÑ">ŸÖŸÇÿ®ŸàŸÑ</option>
              <option value="ÿ¨ŸäÿØ">ÿ¨ŸäÿØ</option>
              <option value="ÿ¨ŸäÿØ ÿ¨ÿØÿß">ÿ¨ŸäÿØ ÿ¨ÿØÿß</option>
              <option value="ŸÖŸÖÿ™ÿßÿ≤">ŸÖŸÖÿ™ÿßÿ≤</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button class="btn btn-success" id="saveStudentBtn">ÿ≠ŸÅÿ∏</button>
        </div>
      </div>
    </div>

    <!-- Modal for Grade Selection -->
    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title">ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ∑ŸÑÿßÿ®</h3>
        <div class="modal-body">
          <select id="gradeSelect">
            <option value="">ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ®</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button class="btn" onclick="filterByGrade()">ÿπÿ±ÿ∂</button>
        </div>
      </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ</h3>
        <div class="modal-body">
          <p id="deleteMessage">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ∑ÿßŸÑÿ®ÿü</p>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button class="btn btn-danger" onclick="confirmDelete()">ŸÜÿπŸÖÿå ÿßÿ≠ÿ∞ŸÅ</button>
        </div>
      </div>
    </div>

    <div class="header">
      <h1>üìö ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∑ŸÑÿßÿ®</h1>
      <div class="grade-select">
        <button onclick="showGradeModal()">üìò ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ</button>
        <button onclick="renderTable()">üìÑ ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ</button>
      </div>
    </div>

    <div class="control-panel">
      <input type="text" id="token" placeholder="üîë GitHub Token">
      <input type="text" id="searchId" placeholder="üîç ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ®">
      <button class="btn" onclick="searchStudent()">ÿ®ÿ≠ÿ´</button>
      <button class="btn btn-success" onclick="showAddModal()">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ®</button>
      <button class="btn" onclick="openFile()">üìÇ ŸÅÿ™ÿ≠ ŸÖŸÑŸÅ</button>
      <button class="btn" onclick="saveToGitHub()">üíæ ÿ≠ŸÅÿ∏</button>
    </div>

    <div id="studentsCount"></div>
    <div id="studentsTable"></div>
  </div>

<script>
let students = {};
let sha = "";
const owner = "Fo-programing";
const repo = "Pro";
const path = "students.json";
const branch = "main";
const PASSWORD = "0101356859001223277310";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let deleteStudentId = null;
let isLoading = false;

const grades = [
  "ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÑÿ´ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä",
  "ÿßŸÑÿµŸÅ ÿßŸÑÿ±ÿßÿ®ÿπ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä", "ÿßŸÑÿµŸÅ ÿßŸÑÿÆÿßŸÖÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä",
  "ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØŸä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä ÿßŸÑÿ•ÿπÿØÿßÿØŸä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÑÿ´ ÿßŸÑÿ•ÿπÿØÿßÿØŸä",
  "ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ÿßŸÑÿ´ÿßŸÜŸàŸä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä ÿßŸÑÿ´ÿßŸÜŸàŸä", "ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÑÿ´ ÿßŸÑÿ´ÿßŸÜŸàŸä"
];

const levels = ["ÿ∂ÿπŸäŸÅ", "ŸÖŸÇÿ®ŸàŸÑ", "ÿ¨ŸäÿØ", "ÿ¨ŸäÿØ ÿ¨ÿØÿß", "ŸÖŸÖÿ™ÿßÿ≤"];

// ÿ£ŸäÿßŸÖ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ Ÿàÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ≥ŸÜÿ© ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
const weekDays = ["ÿßŸÑÿ≥ÿ®ÿ™", "ÿßŸÑÿ£ÿ≠ÿØ", "ÿßŸÑÿßÿ´ŸÜŸäŸÜ", "ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°", "ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°", "ÿßŸÑÿÆŸÖŸäÿ≥", "ÿßŸÑÿ¨ŸÖÿπÿ©"];
const months = ["ÿ£ÿ∫ÿ≥ÿ∑ÿ≥", "ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±", "ÿ£ŸÉÿ™Ÿàÿ®ÿ±", "ŸÜŸàŸÅŸÖÿ®ÿ±", "ÿØŸäÿ≥ŸÖÿ®ÿ±", "ŸäŸÜÿßŸäÿ±", "ŸÅÿ®ÿ±ÿßŸäÿ±", "ŸÖÿßÿ±ÿ≥", "ÿ£ÿ®ÿ±ŸäŸÑ"];

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    document.getElementById("loginScreen").style.display = "none";
    loadStudents();
  } else {
    Swal.fire({
      title: 'ÿÆÿ∑ÿ£!',
      text: 'ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©!',
      icon: 'error',
      confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã'
    });
  }
}

async function loadStudents() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if (!res.ok) throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderTable();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderTable();
    Swal.fire({
      title: 'ÿ™ÿ≠ÿ∞Ÿäÿ±',
      text: 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿßŸÑŸäÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ ÿπŸÜÿØ ÿßŸÑÿ≠ŸÅÿ∏',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

function renderTable(filterGrade = null) {
  let html = `
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>ÿßŸÑŸÉŸàÿØ</th>
            <th>ÿßŸÑÿßÿ≥ŸÖ</th>
            <th>ÿßŸÑÿµŸÅ</th>
            <th>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</th>
            <th>ÿßŸÑÿ≠ÿ∂Ÿàÿ±</th>
            <th>ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™</th>
            <th>ÿ™ÿπÿØŸäŸÑ</th>
            <th>ÿ≠ÿ∞ŸÅ</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  let count = 1;
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
    let attendanceHtml = weekDays.map(day => {
      const status = s.attendance?.[day] || '-';
      return `
        <div class="attendance-select">
          ${day}: 
          <select onchange="updateAttendance('${id}','${day}',this.value)" style="padding: 5px; border-radius: 5px;">
            <option value="ÿ≠ÿßÿ∂ÿ±" ${status === "ÿ≠ÿßÿ∂ÿ±" ? 'selected' : ''}>ÿ≠ÿßÿ∂ÿ±</option>
            <option value="ÿ∫ÿßÿ¶ÿ®" ${status === "ÿ∫ÿßÿ¶ÿ®" ? 'selected' : ''}>ÿ∫ÿßÿ¶ÿ®</option>
            <option value="-" ${status === "-" ? 'selected' : ''}>-</option>
          </select>
        </div>
      `;
    }).join('');
    
    // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™
    let feesHtml = months.map(month => {
      const paid = s.fees?.[month] || false;
      return `
        <div class="fee-checkbox">
          ${month}: 
          <input type="checkbox" onchange="updateFee('${id}','${month}',this.checked)" ${paid ? 'checked' : ''} 
                 style="transform: scale(1.3); margin-right: 5px;">
        </div>
      `;
    }).join('');
    
    html += `
      <tr>
        <td>${count++}</td>
        <td>${id}</td>
        <td>${s.name}</td>
        <td>${s.main}</td>
        <td>${s.info || '-'}</td>
        <td>${attendanceHtml}</td>
        <td>${feesHtml}</td>
        <td><button class="btn" onclick="showEditModal('${id}')">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button></td>
        <td><button class="btn btn-danger" onclick="showDeleteModal('${id}')">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button></td>
      </tr>
    `;
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  document.getElementById('studentsTable').innerHTML = studentCount > 0 ? html : `
    <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <h3 style="color: #666;">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ® ŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿ≠ÿßŸÑŸäÿßŸã</h3>
      <button class="btn btn-success" onclick="showAddModal()" style="margin-top: 20px;">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ</button>
    </div>
  `;
  
  document.getElementById('studentsCount').innerText = `üìä ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿßÿ® ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ŸäŸÜ: ${studentCount}`;
}

function updateAttendance(id, day, value) {
  if (!students[id].attendance) {
    students[id].attendance = {};
  }
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  if (!students[id].fees) {
    students[id].fees = {};
  }
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (!id) {
    Swal.fire({
      title: 'ÿ™ŸÜÿ®ŸäŸá',
      text: 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ® ŸÑŸÑÿ®ÿ≠ÿ´',
      icon: 'warning'
    });
    return;
  }

  if (students[id]) {
    const student = students[id];
    let attendanceList = weekDays.map(day => 
      `<li>${day}: ${student.attendance?.[day] || '-'}</li>`
    ).join('');
    
    let feesList = months.map(month => 
      `<li>${month}: ${student.fees?.[month] ? '‚úÖ ŸÖÿ≥ÿØÿØÿ©' : '‚ùå ÿ∫Ÿäÿ± ŸÖÿ≥ÿØÿØÿ©'}</li>`
    ).join('');
    
    Swal.fire({
      title: 'üìÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿßŸÑÿ®',
      html: `
        <div style="text-align: right;">
          <p><b>ÿßŸÑŸÉŸàÿØ:</b> ${id}</p>
          <p><b>ÿßŸÑÿßÿ≥ŸÖ:</b> ${student.name}</p>
          <p><b>ÿßŸÑÿµŸÅ:</b> ${student.main}</p>
          <p><b>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ:</b> ${student.info || '-'}</p>
          <hr>
          <h4>ÿßŸÑÿ≠ÿ∂Ÿàÿ±:</h4>
          <ul>${attendanceList}</ul>
          <h4>ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™:</h4>
          <ul>${feesList}</ul>
        </div>
      `,
      confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã',
      width: '600px'
    });
  } else {
    Swal.fire({
      title: '‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá',
      text: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ∑ÿßŸÑÿ®',
      confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã'
    });
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function showGradeModal() {
  const gradeSelect = document.getElementById('gradeSelect');
  gradeSelect.innerHTML = '<option value="">ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ®</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderTable(selectedGrade);
  closeModal();
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ';
  document.getElementById('studentId').value = '';
  document.getElementById('studentName').value = '';
  document.getElementById('studentLevel').value = '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
  
  // Focus on first input
  setTimeout(() => {
    document.getElementById('studentId').focus();
  }, 100);
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').textContent = `ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿßŸÑÿ® ${id}`;
  document.getElementById('studentId').value = id;
  document.getElementById('studentName').value = student.name;
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  const levelSelect = document.getElementById('studentLevel');
  levelSelect.innerHTML = '<option value="" disabled>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</option>';
  levels.forEach(level => {
    levelSelect.innerHTML += `<option value="${level}" ${level === student.info ? 'selected' : ''}>${level}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showDeleteModal(id) {
  deleteStudentId = id;
  const student = students[id];
  document.getElementById('deleteMessage').innerHTML = `
    <p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿ™ÿßŸÑŸäÿü</p>
    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px;">
      <p><strong>ÿßŸÑŸÉŸàÿØ:</strong> ${id}</p>
      <p><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${student.name}</p>
      <p><strong>ÿßŸÑÿµŸÅ:</strong> ${student.main}</p>
    </div>
    <p style="color: var(--danger-color); margin-top: 10px;">Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!</p>
  `;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('gradeModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const level = document.getElementById('studentLevel').value;
  
  if (!id) {
    showError('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ®');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (!name) {
    showError('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (!grade) {
    showError('Ÿäÿ¨ÿ® ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸÅ');
    document.getElementById('studentGrade').focus();
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    showError('ŸÉŸàÿØ ÿßŸÑÿ∑ÿßŸÑÿ® ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info: level,
      attendance: Object.fromEntries(weekDays.map(day => [day, "-"])),
      fees: Object.fromEntries(months.map(month => [month, false]))
    };
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info: level,
        attendance: {...students[currentStudentId].attendance},
        fees: {...students[currentStudentId].fees}
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = level;
    }
  }
  
  renderTable();
  closeModal();
  showSuccess('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿßŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
}

function confirmDelete() {
  if (deleteStudentId) {
    delete students[deleteStudentId];
    renderTable();
    closeModal();
    showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ÿßŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
    deleteStudentId = null;
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ£ŸàŸÑÿßŸã');
    document.getElementById('token').focus();
    return;
  }
  localStorage.setItem("gh_token", token);

  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner"></span> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
    saveBtn.disabled = true;
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      showSuccess('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ÿπŸÑŸâ GitHub');
      loadStudents();
    } else {
      const error = await res.json();
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏! ${error.message}`);
    }
  } catch (error) {
    showError(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${error.message}`);
  } finally {
    showLoading(false);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    if (saveBtn) {
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    }
  }
}

function showLoading(show) {
  isLoading = show;
  const loader = document.createElement('div');
  loader.id = 'loadingOverlay';
  loader.style.position = 'fixed';
  loader.style.top = '0';
  loader.style.left = '0';
  loader.style.width = '100%';
  loader.style.height = '100%';
  loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
  loader.style.display = 'flex';
  loader.style.justifyContent = 'center';
  loader.style.alignItems = 'center';
  loader.style.zIndex = '9998';
  loader.innerHTML = `
    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
      <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
      <p style="font-weight: bold;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
    </div>
  `;
  
  if (show) {
    document.body.appendChild(loader);
  } else {
    const existingLoader = document.getElementById('loadingOverlay');
    if (existingLoader) {
      existingLoader.remove();
    }
  }
}

function showError(message) {
  Swal.fire({
    title: '‚ùå ÿÆÿ∑ÿ£',
    text: message,
    icon: 'error',
    confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã'
  });
}

function showSuccess(message) {
  Swal.fire({
    title: '‚úÖ ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠',
    text: message,
    icon: 'success',
    confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã'
  });
}

// Initialize when page loads
window.onload = function() {
  // Check if already logged in
  if (localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    loadStudents();
  }
  
  // Focus on password field if not logged in
  if (document.getElementById('loginScreen').style.display !== 'none') {
    document.getElementById('loginPassword').focus();
  }
};

// Handle login
function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem('isLoggedIn', 'true');
    document.getElementById("loginScreen").style.display = "none";
    loadStudents();
  } else {
    Swal.fire({
      title: 'ÿÆÿ∑ÿ£!',
      text: 'ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©!',
      icon: 'error',
      confirmButtonText: 'ÿ≠ÿ≥ŸÜÿßŸã'
    });
  }
}
</script>
</body>
</html>
