<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الطلاب</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to right, #e3f2fd, #ffffff);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h1 {
      color: #004d7a;
      font-size: 24px;
      margin: 10px 0;
    }
    .grade-select button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #1976d2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .grade-select button:hover {
      background: #125ea5;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Cairo', sans-serif;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #1976d2;
      color: white;
    }
    .btn {
      background-color: #1976d2;
      color: #fff;
      border: none;
      font-weight: bold;
      transition: background 0.3s;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #125ea5;
    }
    .btn-danger {
      background-color: #e53935;
    }
    .btn-success {
      background-color: #43a047;
    }
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right, #ffffff, #e3f2fd);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .login-box {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    #studentsCount {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .modal-body {
      padding: 20px 0;
    }
    .modal-footer {
      text-align: left;
      padding-top: 20px;
    }
    .modal-title {
      margin-top: 0;
      color: #1976d2;
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2>🔒 تسجيل الدخول</h2>
      <input type="password" id="loginPassword" placeholder="ادخل كلمة المرور">
      <button class="btn btn-success" onclick="checkLogin()">دخول</button>
    </div>
  </div>

  <!-- Modal for Add/Edit Student -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title" id="modalTitle">إضافة طالب</h3>
      <div class="modal-body">
        <input type="text" id="studentId" placeholder="كود الطالب">
        <input type="text" id="studentName" placeholder="اسم الطالب">
        <select id="studentGrade">
          <option value="" disabled selected>اختر الصف</option>
        </select>
        <input type="text" id="studentInfo" placeholder="معلومة">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="saveStudentBtn">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Modal for Grade Selection -->
  <div id="gradeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title">اختر الصف لعرض الطلاب</h3>
      <div class="modal-body">
        <select id="gradeSelect" style="width: 100%; padding: 10px;">
          <option value="">عرض جميع الطلاب</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="filterByGrade()">عرض</button>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Confirmation -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title">تأكيد الحذف</h3>
      <div class="modal-body">
        <p id="deleteMessage">هل أنت متأكد من حذف هذا الطالب؟</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="confirmDelete()">نعم، احذف</button>
        <button class="btn" onclick="closeModal()">إلغاء</button>
      </div>
    </div>
  </div>

  <div class="header">
    <h1>📚 لوحة تحكم الطلاب</h1>
    <div class="grade-select">
      <button onclick="showGradeModal()">📘 اختر الصف</button>
      <button onclick="renderTable()">📄 عرض الكل</button>
    </div>
  </div>

  <div class="control-panel">
    <input type="text" id="token" placeholder="🔑 GitHub Token">
    <input type="text" id="searchId" placeholder="🔍 كود الطالب">
    <button class="btn" onclick="searchStudent()">بحث</button>
    <button class="btn btn-success" onclick="showAddModal()">➕ إضافة طالب</button>
    <button class="btn" onclick="openFile()">📂 فتح ملف</button>
    <button class="btn" onclick="saveToGitHub()">💾 حفظ</button>
  </div>

  <div id="studentsCount"></div>
  <div id="studentsTable"></div>

<script>
let students = {};
let sha = "";
const owner = "Fo-programing";
const repo = "Pro";
const path = "students.json";
const branch = "main";
const PASSWORD = "0101356859001223277310";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let deleteStudentId = null;

const grades = [
  "الصف الأول الابتدائي", "الصف الثاني الابتدائي", "الصف الثالث الابتدائي",
  "الصف الرابع الابتدائي", "الصف الخامس الابتدائي", "الصف السادس الابتدائي",
  "الصف الأول الإعدادي", "الصف الثاني الإعدادي", "الصف الثالث الإعدادي",
  "الصف الأول الثانوي", "الصف الثاني الثانوي", "الصف الثالث الثانوي"
];

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    document.getElementById("loginScreen").style.display = "none";
  } else {
    alert("كلمة مرور خاطئة!");
  }
}

async function loadStudents() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderTable();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderTable();
  }
}

function renderTable(filterGrade = null) {
  let html = '<table><thead><tr><th>#</th><th>الكود</th><th>الاسم</th><th>الصف</th><th>معلومة</th><th>الحضور</th><th>المصروفات</th><th>تعديل</th><th>حذف</th></tr></thead><tbody>';
  let count = 1;
  let studentCount = 0;
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    html += `<tr>
      <td>${count++}</td>
      <td>${id}</td>
      <td>${s.name}</td>
      <td>${s.main}</td>
      <td>${s.info}</td>
      <td>${Object.entries(s.attendance).map(([k,v]) => `${k}: <select onchange="updateAttendance('${id}','${k}',this.value)"><option ${v=="حاضر"?'selected':''}>حاضر</option><option ${v=="غائب"?'selected':''}>غائب</option><option ${v=="-"?'selected':''}>-</option></select>`).join('<br>')}</td>
      <td>${Object.entries(s.fees).map(([k,v]) => `${k}: <input type='checkbox' onchange="updateFee('${id}','${k}',this.checked)" ${v?'checked':''}>`).join('<br>')}</td>
      <td><button class="btn" onclick="showEditModal('${id}')">✏️</button></td>
      <td><button class="btn btn-danger" onclick="showDeleteModal('${id}')">🗑️</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('studentsTable').innerHTML = html;
  document.getElementById('studentsCount').innerText = `📊 عدد الطلاب المعروضين: ${studentCount}`;
}

function updateAttendance(id, day, value) {
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (students[id]) {
    Swal.fire({
      title: '📄 بيانات الطالب',
      html: `<b>الاسم:</b> ${students[id].name}<br><b>الصف:</b> ${students[id].main}<br><b>معلومة:</b> ${students[id].info}`,
      confirmButtonText: 'حسناً'
    });
  } else {
    Swal.fire({
      title: '⚠️ تنبيه',
      text: 'لم يتم العثور على الطالب',
      confirmButtonText: 'حسناً'
    });
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function showGradeModal() {
  const gradeSelect = document.getElementById('gradeSelect');
  gradeSelect.innerHTML = '<option value="">عرض جميع الطلاب</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderTable(selectedGrade);
  closeModal();
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').textContent = 'إضافة طالب';
  document.getElementById('studentId').value = '';
  document.getElementById('studentName').value = '';
  document.getElementById('studentInfo').value = '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').textContent = `تعديل بيانات الطالب ${id}`;
  document.getElementById('studentId').value = id;
  document.getElementById('studentName').value = student.name;
  document.getElementById('studentInfo').value = student.info || '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showDeleteModal(id) {
  deleteStudentId = id;
  const student = students[id];
  document.getElementById('deleteMessage').textContent = `هل أنت متأكد من حذف الطالب (${student.name})؟`;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('gradeModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const info = document.getElementById('studentInfo').value.trim();
  
  if (!id) {
    Swal.fire('⚠️ تنبيه', 'يجب إدخال كود الطالب', 'warning');
    return;
  }
  
  if (!name) {
    Swal.fire('⚠️ تنبيه', 'يجب إدخال اسم الطالب', 'warning');
    return;
  }
  
  if (!grade) {
    Swal.fire('⚠️ تنبيه', 'يجب اختيار الصف', 'warning');
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    Swal.fire('⚠️ تنبيه', 'كود الطالب موجود مسبقاً', 'warning');
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info,
      attendance: {"السبت":"-","الأحد":"-","الاثنين":"-","الثلاثاء":"-","الأربعاء":"-","الخميس":"-","الجمعة":"-"},
      fees: {"أغسطس":false,"سبتمبر":false,"أكتوبر":false,"نوفمبر":false,"ديسمبر":false,"يناير":false,"فبراير":false,"مارس":false,"أبريل":false}
    };
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info,
        attendance: students[currentStudentId].attendance,
        fees: students[currentStudentId].fees
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = info;
    }
  }
  
  renderTable();
  closeModal();
  Swal.fire('✅ تم الحفظ', 'تم حفظ بيانات الطالب بنجاح', 'success');
}

function confirmDelete() {
  if (deleteStudentId) {
    delete students[deleteStudentId];
    renderTable();
    closeModal();
    Swal.fire('✅ تم الحذف', 'تم حذف الطالب بنجاح', 'success');
    deleteStudentId = null;
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    Swal.fire('⚠️ تنبيه', 'أدخل التوكن أولاً', 'warning');
    return;
  }
  localStorage.setItem("gh_token", token);

  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث بيانات الطلاب من لوحة التحكم",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      Swal.fire('✅ تم الحفظ', 'تم حفظ البيانات بنجاح على GitHub', 'success');
      loadStudents();
    } else {
      const error = await res.json();
      Swal.fire('❌ خطأ', `فشل في الحفظ! ${error.message}`, 'error');
    }
  } catch (error) {
    Swal.fire('❌ خطأ', `خطأ في الاتصال: ${error.message}`, 'error');
  }
}

// Initialize grade selects
window.onload = function() {
  loadStudents();
};
</script>
</body>
</html>
