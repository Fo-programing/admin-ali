<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS Ø§Ù„ØªÙŠ Ø£Ø±ÙÙ‚ØªÙ‡Ø§ â€” Ù„Ù… ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ */
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #004d7a;
      font-size: 28px;
      margin-bottom: 30px;
    }
    input, button, select {
      padding: 12px 16px;
      margin: 6px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-family: 'Cairo', sans-serif;
      font-size: 16px;
      transition: 0.3s ease;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #1976d2;
      box-shadow: 0 0 6px rgba(25, 118, 210, 0.4);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }
    th {
      background-color: #1976d2;
      color: #fff;
      padding: 14px;
      font-size: 16px;
    }
    td {
      padding: 14px;
      border-bottom: 1px solid #eee;
      text-align: center;
      font-size: 15px;
    }
    .control-panel {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .btn {
      background-color: #1976d2;
      color: #fff;
      border: none;
      font-weight: bold;
      transition: background 0.3s ease;
      cursor: pointer;
    }
    .btn:hover { background-color: #125ea5; }
    .btn-danger { background-color: #e53935; }
    .btn-danger:hover { background-color: #c62828; }
    .btn-success { background-color: #43a047; }
    .btn-success:hover { background-color: #2e7d32; }

    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right, #ffffff, #e3f2fd);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-in-out;
    }
    .login-box {
      background: #ffffff;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      width: 300px;
      animation: scaleUp 0.4s ease-in-out;
    }
    .login-box h2 {
      color: #1976d2;
      margin-bottom: 20px;
      font-size: 22px;
    }
    .login-box input {
      width: 100%;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .login-box .btn-success {
      width: 100%;
      font-size: 16px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes scaleUp {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h2>ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="password" id="loginPassword" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <br>
    <button class="btn btn-success" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<h1>ğŸ“š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</h1>

<div class="control-panel">
  <input type="text" id="token" placeholder="ğŸ”‘ GitHub Token" style="width:300px">
  <input type="text" id="searchId" placeholder="ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¨Ø­Ø«">
  <button class="btn" onclick="searchStudent()">Ø¨Ø­Ø«</button>
  <button class="btn btn-success" onclick="addStudent()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
  <button class="btn" onclick="openFile()">ğŸ“‚ ÙØªØ­ Ù…Ù„Ù GitHub</button>
  <button class="btn" onclick="saveToGitHub()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
</div>

<div id="studentsTable"></div>

<script>
let students = {};
let sha = "";
const owner = "Fo-programing";
const repo = "Pro";
const path = "students.js";
const branch = "main";
const PASSWORD = "admin123";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    document.getElementById("loginScreen").style.display = "none";
  } else {
    alert("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
  }
}

async function loadStudents() {
  let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
  let data = await res.json();
  sha = data.sha;
  let code = atob(data.content);
  let jsonText = code.match(/{[\s\S]*}/)[0];
  students = eval('(' + jsonText + ')');
  renderTable();
}

function renderTable() {
  let html = '<table><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ù…Ø¹Ù„ÙˆÙ…Ø©</th><th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>ØªØ¹Ø¯ÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody>';
  for (let id in students) {
    let s = students[id];
    html += `<tr>
      <td>${id}</td>
      <td>${s.name}</td>
      <td>${s.main}</td>
      <td>${s.info}</td>
      <td>${Object.entries(s.attendance).map(([k,v]) => `${k}: <select onchange="updateAttendance('${id}','${k}',this.value)"><option ${v=="Ø­Ø§Ø¶Ø±"?'selected':''}>Ø­Ø§Ø¶Ø±</option><option ${v=="ØºØ§Ø¦Ø¨"?'selected':''}>ØºØ§Ø¦Ø¨</option><option ${v=="-"?'selected':''}>-</option></select>`).join('<br>')}</td>
      <td>${Object.entries(s.fees).map(([k,v]) => `${k}: <input type='checkbox' onchange="updateFee('${id}','${k}',this.checked)" ${v?'checked':''}>`).join('<br>')}</td>
      <td><button class="btn" onclick="editStudent('${id}')">âœï¸</button></td>
      <td><button class="btn btn-danger" onclick="deleteStudent('${id}')">ğŸ—‘ï¸</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('studentsTable').innerHTML = html;
}

function updateAttendance(id, day, value) {
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (students[id]) {
    Swal.fire({
      title: 'ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨',
      html: `<b>Ø§Ù„Ø§Ø³Ù…:</b> ${students[id].name}<br>
             <b>Ø§Ù„ØµÙ:</b> ${students[id].main}<br>
             <b>Ù…Ø¹Ù„ÙˆÙ…Ø©:</b> ${students[id].info}`,
    });
  } else {
    Swal.fire('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function addStudent() {
  Swal.fire({
    title: 'â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨',
    html: `
      <input id="newId" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨"><br>
      <input id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"><br>
      <input id="newMain" placeholder="Ø§Ù„ØµÙ"><br>
      <input id="newInfo" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø©">
    `,
    preConfirm: () => {
      let id = document.getElementById('newId').value.trim();
      let name = document.getElementById('newName').value;
      let main = document.getElementById('newMain').value;
      let info = document.getElementById('newInfo').value;
      if (!id || students[id]) return Swal.showValidationMessage('ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­');
      students[id] = {
        name, main, info,
        attendance: {"Ø§Ù„Ø³Ø¨Øª":"-","Ø§Ù„Ø£Ø­Ø¯":"-","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†":"-","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡":"-","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡":"-","Ø§Ù„Ø®Ù…ÙŠØ³":"-","Ø§Ù„Ø¬Ù…Ø¹Ø©":"-"},
        fees: {"Ø£ØºØ³Ø·Ø³":false,"Ø³Ø¨ØªÙ…Ø¨Ø±":false,"Ø£ÙƒØªÙˆØ¨Ø±":false,"Ù†ÙˆÙÙ…Ø¨Ø±":false,"Ø¯ÙŠØ³Ù…Ø¨Ø±":false,"ÙŠÙ†Ø§ÙŠØ±":false,"ÙØ¨Ø±Ø§ÙŠØ±":false,"Ù…Ø§Ø±Ø³":false,"Ø£Ø¨Ø±ÙŠÙ„":false}
      };
      renderTable();
    }
  });
}

function editStudent(id) {
  let s = students[id];
  Swal.fire({
    title: `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${id}`,
    html: `
      <input id="editName" value="${s.name}"><br>
      <input id="editMain" value="${s.main}"><br>
      <input id="editInfo" value="${s.info}">
    `,
    preConfirm: () => {
      students[id].name = document.getElementById('editName').value;
      students[id].main = document.getElementById('editMain').value;
      students[id].info = document.getElementById('editInfo').value;
      renderTable();
    }
  });
}

function deleteStudent(id) {
  Swal.fire({
    title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨',
    text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ (${students[id].name})ØŸ`,
    showCancelButton: true,
    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
  }).then((result) => {
    if (result.isConfirmed) {
      delete students[id];
      renderTable();
    }
  });
}

// âœ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) return Swal.fire('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹');
  localStorage.setItem("gh_token", token);

  const content = `const students = ${JSON.stringify(students, null, 2)};`;

  function toBase64Unicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) =>
      String.fromCharCode('0x' + p1)
    ));
  }

  const encoded = toBase64Unicode(content);

  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
      content: encoded,
      sha: sha,
      branch: branch
    })
  });

  if (res.ok) {
    Swal.fire('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
    loadStudents();
  } else {
    Swal.fire('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸! ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
  }
}

loadStudents();
</script>

</body>
</html>
