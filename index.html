<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to right, #e3f2fd, #ffffff);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h1 {
      color: #004d7a;
      font-size: 24px;
      margin: 10px 0;
    }
    .grade-select button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #1976d2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .grade-select button:hover {
      background: #125ea5;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Cairo', sans-serif;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #1976d2;
      color: white;
    }
    .btn {
      background-color: #1976d2;
      color: #fff;
      border: none;
      font-weight: bold;
      transition: background 0.3s;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #125ea5;
    }
    .btn-danger {
      background-color: #e53935;
    }
    .btn-success {
      background-color: #43a047;
    }
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right, #ffffff, #e3f2fd);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .login-box {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    #studentsCount {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .modal-body {
      padding: 20px 0;
    }
    .modal-footer {
      text-align: left;
      padding-top: 20px;
    }
    .modal-title {
      margin-top: 0;
      color: #1976d2;
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2>ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <input type="password" id="loginPassword" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button class="btn btn-success" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Modal for Add/Edit Student -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
      <div class="modal-body">
        <input type="text" id="studentId" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="text" id="studentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <select id="studentGrade">
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
        </select>
        <input type="text" id="studentInfo" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø©">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="saveStudentBtn">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Modal for Grade Selection -->
  <div id="gradeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <div class="modal-body">
        <select id="gradeSelect" style="width: 100%; padding: 10px;">
          <option value="">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="filterByGrade()">Ø¹Ø±Ø¶</button>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Confirmation -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
      <div class="modal-body">
        <p id="deleteMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="confirmDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
        <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <div class="grade-select">
      <button onclick="showGradeModal()">ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„ØµÙ</button>
      <button onclick="renderTable()">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
    </div>
  </div>

  <div class="control-panel">
    <input type="text" id="token" placeholder="ğŸ”‘ GitHub Token">
    <input type="text" id="searchId" placeholder="ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
    <button class="btn" onclick="searchStudent()">Ø¨Ø­Ø«</button>
    <button class="btn btn-success" onclick="showAddModal()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
    <button class="btn" onclick="openFile()">ğŸ“‚ ÙØªØ­ Ù…Ù„Ù</button>
    <button class="btn" onclick="saveToGitHub()">ğŸ’¾ Ø­ÙØ¸</button>
  </div>

  <div id="studentsCount"></div>
  <div id="studentsTable"></div>

<script>
let students = {};
let sha = "";
const owner = "Fo-programing";
const repo = "Pro";
const path = "students.json";
const branch = "main";
const PASSWORD = "0101356859001223277310";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let deleteStudentId = null;

const grades = [
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
];

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    document.getElementById("loginScreen").style.display = "none";
  } else {
    alert("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
  }
}

async function loadStudents() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderTable();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderTable();
  }
}

function renderTable(filterGrade = null) {
  let html = '<table><thead><tr><th>#</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ù…Ø¹Ù„ÙˆÙ…Ø©</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>ØªØ¹Ø¯ÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody>';
  let count = 1;
  let studentCount = 0;
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    html += `<tr>
      <td>${count++}</td>
      <td>${id}</td>
      <td>${s.name}</td>
      <td>${s.main}</td>
      <td>${s.info}</td>
      <td>${Object.entries(s.attendance).map(([k,v]) => `${k}: <select onchange="updateAttendance('${id}','${k}',this.value)"><option ${v=="Ø­Ø§Ø¶Ø±"?'selected':''}>Ø­Ø§Ø¶Ø±</option><option ${v=="ØºØ§Ø¦Ø¨"?'selected':''}>ØºØ§Ø¦Ø¨</option><option ${v=="-"?'selected':''}>-</option></select>`).join('<br>')}</td>
      <td>${Object.entries(s.fees).map(([k,v]) => `${k}: <input type='checkbox' onchange="updateFee('${id}','${k}',this.checked)" ${v?'checked':''}>`).join('<br>')}</td>
      <td><button class="btn" onclick="showEditModal('${id}')">âœï¸</button></td>
      <td><button class="btn btn-danger" onclick="showDeleteModal('${id}')">ğŸ—‘ï¸</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('studentsTable').innerHTML = html;
  document.getElementById('studentsCount').innerText = `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: ${studentCount}`;
}

function updateAttendance(id, day, value) {
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (students[id]) {
    Swal.fire({
      title: 'ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨',
      html: `<b>Ø§Ù„Ø§Ø³Ù…:</b> ${students[id].name}<br><b>Ø§Ù„ØµÙ:</b> ${students[id].main}<br><b>Ù…Ø¹Ù„ÙˆÙ…Ø©:</b> ${students[id].info}`,
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  } else {
    Swal.fire({
      title: 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡',
      text: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨',
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function showGradeModal() {
  const gradeSelect = document.getElementById('gradeSelect');
  gradeSelect.innerHTML = '<option value="">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderTable(selectedGrade);
  closeModal();
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨';
  document.getElementById('studentId').value = '';
  document.getElementById('studentName').value = '';
  document.getElementById('studentInfo').value = '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${id}`;
  document.getElementById('studentId').value = id;
  document.getElementById('studentName').value = student.name;
  document.getElementById('studentInfo').value = student.info || '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showDeleteModal(id) {
  deleteStudentId = id;
  const student = students[id];
  document.getElementById('deleteMessage').textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ (${student.name})ØŸ`;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('gradeModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const info = document.getElementById('studentInfo').value.trim();
  
  if (!id) {
    Swal.fire('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', 'warning');
    return;
  }
  
  if (!name) {
    Swal.fire('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'warning');
    return;
  }
  
  if (!grade) {
    Swal.fire('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ', 'warning');
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    Swal.fire('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning');
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info,
      attendance: {"Ø§Ù„Ø³Ø¨Øª":"-","Ø§Ù„Ø£Ø­Ø¯":"-","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†":"-","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡":"-","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡":"-","Ø§Ù„Ø®Ù…ÙŠØ³":"-","Ø§Ù„Ø¬Ù…Ø¹Ø©":"-"},
      fees: {"Ø£ØºØ³Ø·Ø³":false,"Ø³Ø¨ØªÙ…Ø¨Ø±":false,"Ø£ÙƒØªÙˆØ¨Ø±":false,"Ù†ÙˆÙÙ…Ø¨Ø±":false,"Ø¯ÙŠØ³Ù…Ø¨Ø±":false,"ÙŠÙ†Ø§ÙŠØ±":false,"ÙØ¨Ø±Ø§ÙŠØ±":false,"Ù…Ø§Ø±Ø³":false,"Ø£Ø¨Ø±ÙŠÙ„":false}
    };
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info,
        attendance: students[currentStudentId].attendance,
        fees: students[currentStudentId].fees
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = info;
    }
  }
  
  renderTable();
  closeModal();
  Swal.fire('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function confirmDelete() {
  if (deleteStudentId) {
    delete students[deleteStudentId];
    renderTable();
    closeModal();
    Swal.fire('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    deleteStudentId = null;
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    Swal.fire('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    return;
  }
  localStorage.setItem("gh_token", token);

  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      Swal.fire('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ GitHub', 'success');
      loadStudents();
    } else {
      const error = await res.json();
      Swal.fire('âŒ Ø®Ø·Ø£', `ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸! ${error.message}`, 'error');
    }
  } catch (error) {
    Swal.fire('âŒ Ø®Ø·Ø£', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
  }
}

// Initialize grade selects
window.onload = function() {
  loadStudents();
};
</script>
</body>
</html>
